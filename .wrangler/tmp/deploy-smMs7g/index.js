var Ge=Object.defineProperty;var d=(e,t)=>Ge(e,"name",{value:t,configurable:!0});var ee=d((e,t,r)=>(n,s)=>{let a=-1;return i(0);async function i(c){if(c<=a)throw new Error("next() called multiple times");a=c;let l,o=!1,u;if(e[c]?(u=e[c][0][0],n.req.routeIndex=c):u=c===e.length&&s||void 0,u)try{l=await u(n,()=>i(c+1))}catch(p){if(p instanceof Error&&t)n.error=p,l=await t(p,n),o=!0;else throw p}else n.finalized===!1&&r&&(l=await r(n));return l&&(n.finalized===!1||o)&&(n.res=l),n}},"compose");var he=Symbol();var me=d(async(e,t=Object.create(null))=>{let{all:r=!1,dot:n=!1}=t,a=(e instanceof F?e.raw.headers:e.headers).get("Content-Type");return a?.startsWith("multipart/form-data")||a?.startsWith("application/x-www-form-urlencoded")?ze(e,{all:r,dot:n}):{}},"parseBody");async function ze(e,t){let r=await e.formData();return r?Ke(r,t):{}}d(ze,"parseFormData");function Ke(e,t){let r=Object.create(null);return e.forEach((n,s)=>{t.all||s.endsWith("[]")?We(r,s,n):r[s]=n}),t.dot&&Object.entries(r).forEach(([n,s])=>{n.includes(".")&&(Ve(r,n,s),delete r[n])}),r}d(Ke,"convertFormDataToBodyData");var We=d((e,t,r)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:t.endsWith("[]")?e[t]=[r]:e[t]=r},"handleParsingAllValues"),Ve=d((e,t,r)=>{let n=e,s=t.split(".");s.forEach((a,i)=>{i===s.length-1?n[a]=r:((!n[a]||typeof n[a]!="object"||Array.isArray(n[a])||n[a]instanceof File)&&(n[a]=Object.create(null)),n=n[a])})},"handleParsingNestedValues");var re=d(e=>{let t=e.split("/");return t[0]===""&&t.shift(),t},"splitPath"),fe=d(e=>{let{groups:t,path:r}=Qe(e),n=re(r);return Je(n,t)},"splitRoutingPath"),Qe=d(e=>{let t=[];return e=e.replace(/\{[^}]+\}/g,(r,n)=>{let s=`@${n}`;return t.push([s,r]),s}),{groups:t,path:e}},"extractGroupsFromPath"),Je=d((e,t)=>{for(let r=t.length-1;r>=0;r--){let[n]=t[r];for(let s=e.length-1;s>=0;s--)if(e[s].includes(n)){e[s]=e[s].replace(n,t[r][1]);break}}return e},"replaceGroupMarks"),G={},ge=d((e,t)=>{if(e==="*")return"*";let r=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(r){let n=`${e}#${t}`;return G[n]||(r[2]?G[n]=t&&t[0]!==":"&&t[0]!=="*"?[n,r[1],new RegExp(`^${r[2]}(?=/${t})`)]:[e,r[1],new RegExp(`^${r[2]}$`)]:G[n]=[e,r[1],!0]),G[n]}return null},"getPattern"),z=d((e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,r=>{try{return t(r)}catch{return r}})}},"tryDecode"),Ye=d(e=>z(e,decodeURI),"tryDecodeURI"),ne=d(e=>{let t=e.url,r=t.indexOf("/",t.indexOf(":")+4),n=r;for(;n<t.length;n++){let s=t.charCodeAt(n);if(s===37){let a=t.indexOf("?",n),i=t.slice(r,a===-1?void 0:a);return Ye(i.includes("%25")?i.replace(/%25/g,"%2525"):i)}else if(s===63)break}return t.slice(r,n)},"getPath");var ye=d(e=>{let t=ne(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},"getPathNoStrict"),j=d((e,t,...r)=>(r.length&&(t=j(t,...r)),`${e?.[0]==="/"?"":"/"}${e}${t==="/"?"":`${e?.at(-1)==="/"?"":"/"}${t?.[0]==="/"?t.slice(1):t}`}`),"mergePath"),K=d(e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":"))return null;let t=e.split("/"),r=[],n="";return t.forEach(s=>{if(s!==""&&!/\:/.test(s))n+="/"+s;else if(/\:/.test(s))if(/\?/.test(s)){r.length===0&&n===""?r.push("/"):r.push(n);let a=s.replace("?","");n+="/"+a,r.push(n)}else n+="/"+s}),r.filter((s,a,i)=>i.indexOf(s)===a)},"checkOptionalParameter"),te=d(e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?z(e,se):e):e,"_decodeURI"),be=d((e,t,r)=>{let n;if(!r&&t&&!/[%+]/.test(t)){let i=e.indexOf("?",8);if(i===-1)return;for(e.startsWith(t,i+1)||(i=e.indexOf(`&${t}`,i+1));i!==-1;){let c=e.charCodeAt(i+t.length+1);if(c===61){let l=i+t.length+2,o=e.indexOf("&",l);return te(e.slice(l,o===-1?void 0:o))}else if(c==38||isNaN(c))return"";i=e.indexOf(`&${t}`,i+1)}if(n=/[%+]/.test(e),!n)return}let s={};n??=/[%+]/.test(e);let a=e.indexOf("?",8);for(;a!==-1;){let i=e.indexOf("&",a+1),c=e.indexOf("=",a);c>i&&i!==-1&&(c=-1);let l=e.slice(a+1,c===-1?i===-1?void 0:i:c);if(n&&(l=te(l)),a=i,l==="")continue;let o;c===-1?o="":(o=e.slice(c+1,i===-1?void 0:i),n&&(o=te(o))),r?(s[l]&&Array.isArray(s[l])||(s[l]=[]),s[l].push(o)):s[l]??=o}return t?s[t]:s},"_getQueryParam"),we=be,xe=d((e,t)=>be(e,t,!0),"getQueryParams"),se=decodeURIComponent;var Ee=d(e=>z(e,se),"tryDecodeURIComponent"),F=class{static{d(this,"HonoRequest")}raw;#t;#e;routeIndex=0;path;bodyCache={};constructor(e,t="/",r=[[]]){this.raw=e,this.path=t,this.#e=r,this.#t={}}param(e){return e?this.#r(e):this.#o()}#r(e){let t=this.#e[0][this.routeIndex][1][e],r=this.#s(t);return r&&/\%/.test(r)?Ee(r):r}#o(){let e={},t=Object.keys(this.#e[0][this.routeIndex][1]);for(let r of t){let n=this.#s(this.#e[0][this.routeIndex][1][r]);n!==void 0&&(e[r]=/\%/.test(n)?Ee(n):n)}return e}#s(e){return this.#e[1]?this.#e[1][e]:e}query(e){return we(this.url,e)}queries(e){return xe(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;let t={};return this.raw.headers.forEach((r,n)=>{t[n]=r}),t}async parseBody(e){return this.bodyCache.parsedBody??=await me(this,e)}#n=d(e=>{let{bodyCache:t,raw:r}=this,n=t[e];if(n)return n;let s=Object.keys(t)[0];return s?t[s].then(a=>(s==="json"&&(a=JSON.stringify(a)),new Response(a)[e]())):t[e]=r[e]()},"#cachedBody");json(){return this.#n("text").then(e=>JSON.parse(e))}text(){return this.#n("text")}arrayBuffer(){return this.#n("arrayBuffer")}blob(){return this.#n("blob")}formData(){return this.#n("formData")}addValidatedData(e,t){this.#t[e]=t}valid(e){return this.#t[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[he](){return this.#e}get matchedRoutes(){return this.#e[0].map(([[,e]])=>e)}get routePath(){return this.#e[0].map(([[,e]])=>e)[this.routeIndex].path}};var ve={Stringify:1,BeforeStream:2,Stream:3},Ze=d((e,t)=>{let r=new String(e);return r.isEscaped=!0,r.callbacks=t,r},"raw");var oe=d(async(e,t,r,n,s)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));let a=e.callbacks;if(!a?.length)return Promise.resolve(e);s?s[0]+=e:s=[e];let i=Promise.all(a.map(c=>c({phase:t,buffer:s,context:n}))).then(c=>Promise.all(c.filter(Boolean).map(l=>oe(l,t,!1,n,s))).then(()=>s[0]));return r?Ze(await i,a):i},"resolveCallback");var et="text/plain; charset=UTF-8",ie=d((e,t)=>({"Content-Type":e,...t}),"setDefaultContentType"),Re=class{static{d(this,"Context")}#t;#e;env={};#r;finalized=!1;error;#o;#s;#n;#u;#c;#l;#a;#d;#p;constructor(e,t){this.#t=e,t&&(this.#s=t.executionCtx,this.env=t.env,this.#l=t.notFoundHandler,this.#p=t.path,this.#d=t.matchResult)}get req(){return this.#e??=new F(this.#t,this.#p,this.#d),this.#e}get event(){if(this.#s&&"respondWith"in this.#s)return this.#s;throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#s)return this.#s;throw Error("This context has no ExecutionContext")}get res(){return this.#n||=new Response(null,{headers:this.#a??=new Headers})}set res(e){if(this.#n&&e){e=new Response(e.body,e);for(let[t,r]of this.#n.headers.entries())if(t!=="content-type")if(t==="set-cookie"){let n=this.#n.headers.getSetCookie();e.headers.delete("set-cookie");for(let s of n)e.headers.append("set-cookie",s)}else e.headers.set(t,r)}this.#n=e,this.finalized=!0}render=d((...e)=>(this.#c??=t=>this.html(t),this.#c(...e)),"render");setLayout=d(e=>this.#u=e,"setLayout");getLayout=d(()=>this.#u,"getLayout");setRenderer=d(e=>{this.#c=e},"setRenderer");header=d((e,t,r)=>{this.finalized&&(this.#n=new Response(this.#n.body,this.#n));let n=this.#n?this.#n.headers:this.#a??=new Headers;t===void 0?n.delete(e):r?.append?n.append(e,t):n.set(e,t)},"header");status=d(e=>{this.#o=e},"status");set=d((e,t)=>{this.#r??=new Map,this.#r.set(e,t)},"set");get=d(e=>this.#r?this.#r.get(e):void 0,"get");get var(){return this.#r?Object.fromEntries(this.#r):{}}#i(e,t,r){let n=this.#n?new Headers(this.#n.headers):this.#a??new Headers;if(typeof t=="object"&&"headers"in t){let a=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(let[i,c]of a)i.toLowerCase()==="set-cookie"?n.append(i,c):n.set(i,c)}if(r)for(let[a,i]of Object.entries(r))if(typeof i=="string")n.set(a,i);else{n.delete(a);for(let c of i)n.append(a,c)}let s=typeof t=="number"?t:t?.status??this.#o;return new Response(e,{status:s,headers:n})}newResponse=d((...e)=>this.#i(...e),"newResponse");body=d((e,t,r)=>this.#i(e,t,r),"body");text=d((e,t,r)=>!this.#a&&!this.#o&&!t&&!r&&!this.finalized?new Response(e):this.#i(e,t,ie(et,r)),"text");json=d((e,t,r)=>this.#i(JSON.stringify(e),t,ie("application/json",r)),"json");html=d((e,t,r)=>{let n=d(s=>this.#i(s,t,ie("text/html; charset=UTF-8",r)),"res");return typeof e=="object"?oe(e,ve.Stringify,!1,{}).then(n):n(e)},"html");redirect=d((e,t)=>{let r=String(e);return this.header("Location",/[^\x00-\xFF]/.test(r)?encodeURI(r):r),this.newResponse(null,t??302)},"redirect");notFound=d(()=>(this.#l??=()=>new Response,this.#l(this)),"notFound")};var g="ALL",Se="all",Pe=["get","post","put","delete","options","patch"],W="Can not add a route since the matcher is already built.",V=class extends Error{static{d(this,"UnsupportedPathError")}};var Te="__COMPOSED_HANDLER";var tt=d(e=>e.text("404 Not Found",404),"notFoundHandler"),Ae=d((e,t)=>{if("getResponse"in e){let r=e.getResponse();return t.newResponse(r.body,r)}return console.error(e),t.text("Internal Server Error",500)},"errorHandler"),ke=class Ce{static{d(this,"_Hono")}get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#t="/";routes=[];constructor(t={}){[...Pe,Se].forEach(a=>{this[a]=(i,...c)=>(typeof i=="string"?this.#t=i:this.#o(a,this.#t,i),c.forEach(l=>{this.#o(a,this.#t,l)}),this)}),this.on=(a,i,...c)=>{for(let l of[i].flat()){this.#t=l;for(let o of[a].flat())c.map(u=>{this.#o(o.toUpperCase(),this.#t,u)})}return this},this.use=(a,...i)=>(typeof a=="string"?this.#t=a:(this.#t="*",i.unshift(a)),i.forEach(c=>{this.#o(g,this.#t,c)}),this);let{strict:n,...s}=t;Object.assign(this,s),this.getPath=n??!0?t.getPath??ne:ye}#e(){let t=new Ce({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,t.#r=this.#r,t.routes=this.routes,t}#r=tt;errorHandler=Ae;route(t,r){let n=this.basePath(t);return r.routes.map(s=>{let a;r.errorHandler===Ae?a=s.handler:(a=d(async(i,c)=>(await ee([],r.errorHandler)(i,()=>s.handler(i,c))).res,"handler"),a[Te]=s.handler),n.#o(s.method,s.path,a)}),this}basePath(t){let r=this.#e();return r._basePath=j(this._basePath,t),r}onError=d(t=>(this.errorHandler=t,this),"onError");notFound=d(t=>(this.#r=t,this),"notFound");mount(t,r,n){let s,a;n&&(typeof n=="function"?a=n:(a=n.optionHandler,n.replaceRequest===!1?s=d(l=>l,"replaceRequest"):s=n.replaceRequest));let i=a?l=>{let o=a(l);return Array.isArray(o)?o:[o]}:l=>{let o;try{o=l.executionCtx}catch{}return[l.env,o]};s||=(()=>{let l=j(this._basePath,t),o=l==="/"?0:l.length;return u=>{let p=new URL(u.url);return p.pathname=p.pathname.slice(o)||"/",new Request(p,u)}})();let c=d(async(l,o)=>{let u=await r(s(l.req.raw),...i(l));if(u)return u;await o()},"handler");return this.#o(g,j(t,"*"),c),this}#o(t,r,n){t=t.toUpperCase(),r=j(this._basePath,r);let s={basePath:this._basePath,path:r,method:t,handler:n};this.router.add(t,r,[n,s]),this.routes.push(s)}#s(t,r){if(t instanceof Error)return this.errorHandler(t,r);throw t}#n(t,r,n,s){if(s==="HEAD")return(async()=>new Response(null,await this.#n(t,r,n,"GET")))();let a=this.getPath(t,{env:n}),i=this.router.match(s,a),c=new Re(t,{path:a,matchResult:i,env:n,executionCtx:r,notFoundHandler:this.#r});if(i[0].length===1){let o;try{o=i[0][0][0][0](c,async()=>{c.res=await this.#r(c)})}catch(u){return this.#s(u,c)}return o instanceof Promise?o.then(u=>u||(c.finalized?c.res:this.#r(c))).catch(u=>this.#s(u,c)):o??this.#r(c)}let l=ee(i[0],this.errorHandler,this.#r);return(async()=>{try{let o=await l(c);if(!o.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return o.res}catch(o){return this.#s(o,c)}})()}fetch=d((t,...r)=>this.#n(t,r[1],r[0],t.method),"fetch");request=d((t,r,n,s)=>t instanceof Request?this.fetch(r?new Request(t,r):t,n,s):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${j("/",t)}`,r),n,s)),"request");fire=d(()=>{addEventListener("fetch",t=>{t.respondWith(this.#n(t.request,t,void 0,t.request.method))})},"fire")};var Q=[];function ae(e,t){let r=this.buildAllMatchers(),n=d(((s,a)=>{let i=r[s]||r[g],c=i[2][a];if(c)return c;let l=a.match(i[0]);if(!l)return[[],Q];let o=l.indexOf("",1);return[i[1][o],l]}),"match2");return this.match=n,n(e,t)}d(ae,"match");var J="[^/]+",H=".*",N="(?:|/.*)",O=Symbol(),rt=new Set(".\\+*[^]$()");function nt(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===H||e===N?1:t===H||t===N?-1:e===J?1:t===J?-1:e.length===t.length?e<t?-1:1:t.length-e.length}d(nt,"compareKey");var je=class ce{static{d(this,"_Node")}#t;#e;#r=Object.create(null);insert(t,r,n,s,a){if(t.length===0){if(this.#t!==void 0)throw O;if(a)return;this.#t=r;return}let[i,...c]=t,l=i==="*"?c.length===0?["","",H]:["","",J]:i==="/*"?["","",N]:i.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),o;if(l){let u=l[1],p=l[2]||J;if(u&&l[2]&&(p===".*"||(p=p.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(p))))throw O;if(o=this.#r[p],!o){if(Object.keys(this.#r).some(h=>h!==H&&h!==N))throw O;if(a)return;o=this.#r[p]=new ce,u!==""&&(o.#e=s.varIndex++)}!a&&u!==""&&n.push([u,o.#e])}else if(o=this.#r[i],!o){if(Object.keys(this.#r).some(u=>u.length>1&&u!==H&&u!==N))throw O;if(a)return;o=this.#r[i]=new ce}o.insert(c,r,n,s,a)}buildRegExpStr(){let r=Object.keys(this.#r).sort(nt).map(n=>{let s=this.#r[n];return(typeof s.#e=="number"?`(${n})@${s.#e}`:rt.has(n)?`\\${n}`:n)+s.buildRegExpStr()});return typeof this.#t=="number"&&r.unshift(`#${this.#t}`),r.length===0?"":r.length===1?r[0]:"(?:"+r.join("|")+")"}};var Oe=class{static{d(this,"Trie")}#t={varIndex:0};#e=new je;insert(e,t,r){let n=[],s=[];for(let i=0;;){let c=!1;if(e=e.replace(/\{[^}]+\}/g,l=>{let o=`@\\${i}`;return s[i]=[o,l],i++,c=!0,o}),!c)break}let a=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let i=s.length-1;i>=0;i--){let[c]=s[i];for(let l=a.length-1;l>=0;l--)if(a[l].indexOf(c)!==-1){a[l]=a[l].replace(c,s[i][1]);break}}return this.#e.insert(a,t,n,this.#t,r),n}buildRegExp(){let e=this.#e.buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0,r=[],n=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(s,a,i)=>a!==void 0?(r[++t]=Number(a),"$()"):(i!==void 0&&(n[Number(i)]=++t),"")),[new RegExp(`^${e}`),r,n]}};var st=[/^$/,[],Object.create(null)],De=Object.create(null);function qe(e){return De[e]??=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,r)=>r?`\\${r}`:"(?:|/.*)")}$`)}d(qe,"buildWildcardRegExp");function ot(){De=Object.create(null)}d(ot,"clearWildcardRegExpCache");function it(e){let t=new Oe,r=[];if(e.length===0)return st;let n=e.map(o=>[!/\*|\/:/.test(o[0]),...o]).sort(([o,u],[p,h])=>o?1:p?-1:u.length-h.length),s=Object.create(null);for(let o=0,u=-1,p=n.length;o<p;o++){let[h,m,w]=n[o];h?s[m]=[w.map(([y])=>[y,Object.create(null)]),Q]:u++;let f;try{f=t.insert(m,u,h)}catch(y){throw y===O?new V(m):y}h||(r[u]=w.map(([y,b])=>{let D=Object.create(null);for(b-=1;b>=0;b--){let[U,E]=f[b];D[U]=E}return[y,D]}))}let[a,i,c]=t.buildRegExp();for(let o=0,u=r.length;o<u;o++)for(let p=0,h=r[o].length;p<h;p++){let m=r[o][p]?.[1];if(!m)continue;let w=Object.keys(m);for(let f=0,y=w.length;f<y;f++)m[w[f]]=c[m[w[f]]]}let l=[];for(let o in i)l[o]=r[i[o]];return[a,l,s]}d(it,"buildMatcherFromPreprocessedRoutes");function q(e,t){if(e){for(let r of Object.keys(e).sort((n,s)=>s.length-n.length))if(qe(r).test(t))return[...e[r]]}}d(q,"findMiddleware");var Y=class{static{d(this,"RegExpRouter")}name="RegExpRouter";#t;#e;constructor(){this.#t={[g]:Object.create(null)},this.#e={[g]:Object.create(null)}}add(e,t,r){let n=this.#t,s=this.#e;if(!n||!s)throw new Error(W);n[e]||[n,s].forEach(c=>{c[e]=Object.create(null),Object.keys(c[g]).forEach(l=>{c[e][l]=[...c[g][l]]})}),t==="/*"&&(t="*");let a=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){let c=qe(t);e===g?Object.keys(n).forEach(l=>{n[l][t]||=q(n[l],t)||q(n[g],t)||[]}):n[e][t]||=q(n[e],t)||q(n[g],t)||[],Object.keys(n).forEach(l=>{(e===g||e===l)&&Object.keys(n[l]).forEach(o=>{c.test(o)&&n[l][o].push([r,a])})}),Object.keys(s).forEach(l=>{(e===g||e===l)&&Object.keys(s[l]).forEach(o=>c.test(o)&&s[l][o].push([r,a]))});return}let i=K(t)||[t];for(let c=0,l=i.length;c<l;c++){let o=i[c];Object.keys(s).forEach(u=>{(e===g||e===u)&&(s[u][o]||=[...q(n[u],o)||q(n[g],o)||[]],s[u][o].push([r,a-l+c+1]))})}}match=ae;buildAllMatchers(){let e=Object.create(null);return Object.keys(this.#e).concat(Object.keys(this.#t)).forEach(t=>{e[t]||=this.#r(t)}),this.#t=this.#e=void 0,ot(),e}#r(e){let t=[],r=e===g;return[this.#t,this.#e].forEach(n=>{let s=n[e]?Object.keys(n[e]).map(a=>[a,n[e][a]]):[];s.length!==0?(r||=!0,t.push(...s)):e!==g&&t.push(...Object.keys(n[g]).map(a=>[a,n[g][a]]))}),r?it(t):null}};var le=class{static{d(this,"SmartRouter")}name="SmartRouter";#t=[];#e=[];constructor(e){this.#t=e.routers}add(e,t,r){if(!this.#e)throw new Error(W);this.#e.push([e,t,r])}match(e,t){if(!this.#e)throw new Error("Fatal error");let r=this.#t,n=this.#e,s=r.length,a=0,i;for(;a<s;a++){let c=r[a];try{for(let l=0,o=n.length;l<o;l++)c.add(...n[l]);i=c.match(e,t)}catch(l){if(l instanceof V)continue;throw l}this.match=c.match.bind(c),this.#t=[c],this.#e=void 0;break}if(a===s)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,i}get activeRouter(){if(this.#e||this.#t.length!==1)throw new Error("No active router has been determined yet.");return this.#t[0]}};var L=Object.create(null),Ie=class _e{static{d(this,"_Node")}#t;#e;#r;#o=0;#s=L;constructor(t,r,n){if(this.#e=n||Object.create(null),this.#t=[],t&&r){let s=Object.create(null);s[t]={handler:r,possibleKeys:[],score:0},this.#t=[s]}this.#r=[]}insert(t,r,n){this.#o=++this.#o;let s=this,a=fe(r),i=[];for(let c=0,l=a.length;c<l;c++){let o=a[c],u=a[c+1],p=ge(o,u),h=Array.isArray(p)?p[0]:o;if(h in s.#e){s=s.#e[h],p&&i.push(p[1]);continue}s.#e[h]=new _e,p&&(s.#r.push(p),i.push(p[1])),s=s.#e[h]}return s.#t.push({[t]:{handler:n,possibleKeys:i.filter((c,l,o)=>o.indexOf(c)===l),score:this.#o}}),s}#n(t,r,n,s){let a=[];for(let i=0,c=t.#t.length;i<c;i++){let l=t.#t[i],o=l[r]||l[g],u={};if(o!==void 0&&(o.params=Object.create(null),a.push(o),n!==L||s&&s!==L))for(let p=0,h=o.possibleKeys.length;p<h;p++){let m=o.possibleKeys[p],w=u[o.score];o.params[m]=s?.[m]&&!w?s[m]:n[m]??s?.[m],u[o.score]=!0}}return a}search(t,r){let n=[];this.#s=L;let a=[this],i=re(r),c=[];for(let l=0,o=i.length;l<o;l++){let u=i[l],p=l===o-1,h=[];for(let m=0,w=a.length;m<w;m++){let f=a[m],y=f.#e[u];y&&(y.#s=f.#s,p?(y.#e["*"]&&n.push(...this.#n(y.#e["*"],t,f.#s)),n.push(...this.#n(y,t,f.#s))):h.push(y));for(let b=0,D=f.#r.length;b<D;b++){let U=f.#r[b],E=f.#s===L?{}:{...f.#s};if(U==="*"){let A=f.#e["*"];A&&(n.push(...this.#n(A,t,f.#s)),A.#s=E,h.push(A));continue}let[Xe,pe,$]=U;if(!u&&!($ instanceof RegExp))continue;let v=f.#e[Xe],Ue=i.slice(l).join("/");if($ instanceof RegExp){let A=$.exec(Ue);if(A){if(E[pe]=A[0],n.push(...this.#n(v,t,f.#s,E)),Object.keys(v.#e).length){v.#s=E;let Fe=A[0].match(/\//)?.length??0;(c[Fe]||=[]).push(v)}continue}}($===!0||$.test(u))&&(E[pe]=u,p?(n.push(...this.#n(v,t,E,f.#s)),v.#e["*"]&&n.push(...this.#n(v.#e["*"],t,E,f.#s))):(v.#s=E,h.push(v)))}}a=h.concat(c.shift()??[])}return n.length>1&&n.sort((l,o)=>l.score-o.score),[n.map(({handler:l,params:o})=>[l,o])]}};var ue=class{static{d(this,"TrieRouter")}name="TrieRouter";#t;constructor(){this.#t=new Ie}add(e,t,r){let n=K(t);if(n){for(let s=0,a=n.length;s<a;s++)this.#t.insert(e,n[s],r);return}this.#t.insert(e,t,r)}match(e,t){return this.#t.search(e,t)}};var x=class extends ke{static{d(this,"Hono")}constructor(e={}){super(e),this.router=e.router??new le({routers:[new Y,new ue]})}};var Me=d(e=>{let r={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...e},n=(a=>typeof a=="string"?a==="*"?()=>a:i=>a===i?i:null:typeof a=="function"?a:i=>a.includes(i)?i:null)(r.origin),s=(a=>typeof a=="function"?a:Array.isArray(a)?()=>a:()=>[])(r.allowMethods);return d(async function(i,c){function l(u,p){i.res.headers.set(u,p)}d(l,"set");let o=await n(i.req.header("origin")||"",i);if(o&&l("Access-Control-Allow-Origin",o),r.credentials&&l("Access-Control-Allow-Credentials","true"),r.exposeHeaders?.length&&l("Access-Control-Expose-Headers",r.exposeHeaders.join(",")),i.req.method==="OPTIONS"){r.origin!=="*"&&l("Vary","Origin"),r.maxAge!=null&&l("Access-Control-Max-Age",r.maxAge.toString());let u=await s(i.req.header("origin")||"",i);u.length&&l("Access-Control-Allow-Methods",u.join(","));let p=r.allowHeaders;if(!p?.length){let h=i.req.header("Access-Control-Request-Headers");h&&(p=h.split(/\s*,\s*/))}return p?.length&&(l("Access-Control-Allow-Headers",p.join(",")),i.res.headers.append("Vary","Access-Control-Request-Headers")),i.res.headers.delete("Content-Length"),i.res.headers.delete("Content-Type"),new Response(null,{headers:i.res.headers,status:204,statusText:"No Content"})}await c(),r.origin!=="*"&&i.header("Vary","Origin",{append:!0})},"cors2")},"cors");var S=new x,R=new Map;S.post("/register",async e=>{let t=await e.req.json(),{url:r,name:n,description:s,owner:a,price:i,token:c,tags:l,category:o,openApiSpec:u}=t;if(!r||!n||!a||i===void 0||!c)return e.json({error:"Missing required fields: url, name, owner, price, token"},400);let p=await at(r);if(!p.valid)return e.json({error:"Endpoint is not x402 compliant",details:p.error,help:"Your endpoint must return 402 with payment requirements"},400);let h=ct(),m={id:h,url:r,name:n,description:s||"",owner:a,price:i,token:c,tags:l||[],category:o||"utility",openApiSpec:u,verified:p.valid,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),stats:{totalCalls:0,calls24h:0,revenue24h:0,avgResponseTime:p.responseTime||0,uptime:100,lastChecked:new Date().toISOString()}};return R.set(h,m),e.json({success:!0,endpoint:{id:m.id,url:m.url,name:m.name,verified:m.verified,registryUrl:`https://x402.registry/endpoint/${h}`},message:"Endpoint registered successfully! It will appear in search results."},201)});S.get("/search",e=>{let t=e.req.query("tag"),r=e.req.query("category"),n=e.req.query("token"),s=e.req.query("q"),a=parseInt(e.req.query("limit")||"20"),i=parseInt(e.req.query("offset")||"0"),c=Array.from(R.values());if(t&&(c=c.filter(o=>o.tags.includes(t))),r&&(c=c.filter(o=>o.category===r)),n&&(c=c.filter(o=>o.token===n)),s){let o=s.toLowerCase();c=c.filter(u=>u.name.toLowerCase().includes(o)||u.description.toLowerCase().includes(o)||u.tags.some(p=>p.toLowerCase().includes(o)))}c.sort((o,u)=>u.stats.calls24h-o.stats.calls24h);let l=c.length;return c=c.slice(i,i+a),e.json({results:c.map(B),total:l,limit:a,offset:i,hasMore:i+a<l})});S.get("/discover",e=>{let t=Array.from(R.values()),r=[...t].sort((i,c)=>c.stats.calls24h-i.stats.calls24h).slice(0,10),n=[...t].sort((i,c)=>new Date(c.createdAt).getTime()-new Date(i.createdAt).getTime()).slice(0,10),s=new Map;t.forEach(i=>{let c=s.get(i.category)||[];c.push(i),s.set(i.category,c)});let a={};return s.forEach((i,c)=>{a[c]=i.slice(0,5).map(B)}),e.json({trending:r.map(B),new:n.map(B),byCategory:a,totalEndpoints:t.length,categories:Array.from(s.keys())})});S.get("/:id",e=>{let t=e.req.param("id"),r=R.get(t);return r?e.json(r):e.json({error:"Endpoint not found"},404)});S.get("/:id/stats",e=>{let t=e.req.param("id"),r=R.get(t);return r?e.json({endpointId:t,name:r.name,stats:r.stats,pricing:{price:r.price,token:r.token}}):e.json({error:"Endpoint not found"},404)});S.delete("/:id",async e=>{let t=e.req.param("id"),r=e.req.header("X-Owner-Address"),n=R.get(t);return n?n.owner!==r?e.json({error:"Not authorized"},403):(R.delete(t),e.json({success:!0,message:"Endpoint removed"})):e.json({error:"Endpoint not found"},404)});S.put("/:id",async e=>{let t=e.req.param("id"),r=e.req.header("X-Owner-Address"),n=await e.req.json(),s=R.get(t);if(!s)return e.json({error:"Endpoint not found"},404);if(s.owner!==r)return e.json({error:"Not authorized"},403);let a=["name","description","price","tags","category","openApiSpec"];for(let i of a)n[i]!==void 0&&(s[i]=n[i]);return s.updatedAt=new Date().toISOString(),R.set(t,s),e.json({success:!0,endpoint:B(s)})});async function at(e){try{let t=Date.now(),r=await fetch(e,{method:"GET",headers:{Accept:"application/json"}}),n=Date.now()-t;if(r.status===402){let s=await r.json().catch(()=>({}));return s.maxAmountRequired||s.amount||s.payTo||s.payment?{valid:!0,responseTime:n}:{valid:!1,error:"402 response missing payment requirements (maxAmountRequired, payTo)",responseTime:n}}return r.status===200?{valid:!0,responseTime:n}:{valid:!1,error:`Expected 402 status, got ${r.status}`,responseTime:n}}catch(t){return{valid:!1,error:`Failed to reach endpoint: ${t.message}`}}}d(at,"verifyX402Endpoint");function ct(){return Math.random().toString(36).substring(2,15)}d(ct,"generateId");function B(e){return{id:e.id,url:e.url,name:e.name,description:e.description,price:e.price,token:e.token,tags:e.tags,category:e.category,verified:e.verified,calls24h:e.stats.calls24h,uptime:e.stats.uptime}}d(B,"summarizeEndpoint");var P=new x,k=new Map,X=new Map;P.get("/capabilities",e=>{let t=Array.from(X.keys()).sort(),r=t.map(n=>{let s=X.get(n)||new Set;return{capability:n,agentCount:s.size,description:lt(n)}});return e.json({totalCapabilities:t.length,totalAgents:k.size,capabilities:r,categories:[{name:"ai",description:"AI/ML services (summarization, generation, analysis)"},{name:"blockchain",description:"Blockchain queries and transactions"},{name:"data",description:"Data transformation and processing"},{name:"web",description:"Web scraping and API calls"},{name:"media",description:"Image, audio, video processing"},{name:"finance",description:"Pricing, payments, trading"}]})});P.post("/recommend",async e=>{let t=await e.req.json(),{task:r,budget:n,token:s,capabilities:a}=t;if(!r)return e.json({error:"Task description required"},400);let i=a||$e(r),c=[];k.forEach(u=>{let p=u.capabilities.filter(h=>i.includes(h));p.length>0&&c.push({agent:u,score:p.length/i.length,matchedCapabilities:p})}),c.sort((u,p)=>p.score-u.score);let l=c.filter(u=>!n||u.agent.pricing.basePrice<=n).map(u=>({id:u.agent.id,name:u.agent.name,description:u.agent.description,matchScore:Math.round(u.score*100),matchedCapabilities:u.matchedCapabilities,pricing:u.agent.pricing})),o=ut(r,l);return e.json({task:r,inferredCapabilities:i,recommendations:l.slice(0,10),executionPlan:o,estimatedCost:o.totalCost})});P.get("/:id/openapi",e=>{let t=e.req.param("id"),r=k.get(t);if(!r)return e.json({error:"Agent not found"},404);let n={openapi:"3.0.0",info:{title:r.name,description:r.description,version:"1.0.0"},servers:[{url:"https://x402.registry/agents"}],paths:{[`/${r.id}/execute`]:{post:{summary:`Execute ${r.name}`,description:r.description,requestBody:{required:!0,content:{"application/json":{schema:{type:"object",properties:{task:{type:"string"},params:{type:"object"}}}}}},responses:{200:{description:"Successful execution"},402:{description:"Payment required"}}}}},"x-capabilities":r.capabilities,"x-pricing":r.pricing,"x-payment":{required:!0,token:r.pricing.token,amount:r.pricing.basePrice}};return e.json(n)});P.post("/execute",async e=>{let t=await e.req.json(),{task:r,budget:n,token:s,preferredAgents:a,timeout:i}=t;if(!r||!n||!s)return e.json({error:"Required: task, budget, token"},400);if(!e.req.header("X-Payment-Proof")){let b=Math.ceil(n*.1);return e.json({error:"Payment Required",payment:{amount:n+b,token:s,recipient:"SP2QXPFF4M72QYZWXE7S5321XJDJ2DD32DGEMN5QA",memo:`execute:${Z()}`,breakdown:{agentBudget:n,platformFee:b,total:n+b}},task:r,estimatedAgents:3},402)}let l=Z(),o=Date.now(),u=$e(r),p=dt(u,n,a),h=[],m=n;for(let b of p){if(m<b.pricing.basePrice)break;h.push({agentId:b.id,endpoint:b.endpoints[0]||"internal",cost:b.pricing.basePrice,responseTime:Math.random()*500+100}),m-=b.pricing.basePrice}let w=h.reduce((b,D)=>b+D.cost,0),f=Math.ceil(w*.1),y={id:l,task:r,status:"completed",result:{summary:`Executed task "${r}" using ${h.length} agents`,output:"This is a PoC - real execution would return actual results",confidence:.85},agentsUsed:h,totalCost:w,platformFee:f,duration:Date.now()-o};return e.json(y)});P.post("/chain",async e=>{let t=await e.req.json(),{steps:r,budget:n,token:s}=t;if(!r||!Array.isArray(r)||r.length===0)return e.json({error:"Steps array required"},400);let a=r.map((o,u)=>{let p=k.get(o.agentId);return{step:u+1,agentId:o.agentId,agentName:p?.name||"Unknown",action:o.action,estimatedCost:p?.pricing.basePrice||0,inputFrom:o.inputFrom||(u>0?`step${u}`:"user")}}),i=a.reduce((o,u)=>o+u.estimatedCost,0),c=Math.ceil(i*.1);return e.req.header("X-Payment-Proof")?e.json({id:Z(),status:"completed",chain:a,results:a.map(o=>({step:o.step,status:"completed",output:`Result from ${o.agentName}`})),totalCost:i,platformFee:c}):e.json({error:"Payment Required",payment:{amount:i+c,token:s||"sBTC",recipient:"SP2QXPFF4M72QYZWXE7S5321XJDJ2DD32DGEMN5QA",memo:`chain:${Z()}`},chain:a,totalSteps:r.length},402)});P.post("/register",async e=>{let t=await e.req.json(),{name:r,description:n,capabilities:s,endpoints:a,owner:i,pricing:c}=t;if(!r||!s||!i||!c)return e.json({error:"Required: name, capabilities, owner, pricing"},400);let l=pt(),o={id:l,name:r,description:n||"",capabilities:s,endpoints:a||[],owner:i,pricing:c};return k.set(l,o),s.forEach(u=>{let p=X.get(u)||new Set;p.add(l),X.set(u,p)}),e.json({success:!0,agent:{id:l,name:r,capabilities:s},message:"Agent registered successfully"},201)});P.get("/",e=>{let t=Array.from(k.values()).map(r=>({id:r.id,name:r.name,description:r.description,capabilities:r.capabilities,pricing:r.pricing}));return e.json({total:t.length,agents:t})});function $e(e){let t=e.toLowerCase(),r=[],n={summarize:["summarize","summary","tldr","condense"],translate:["translate","translation","language"],"image-generate":["generate image","create image","draw","illustration"],"image-analyze":["analyze image","describe image","what's in this"],search:["search","find","look up","google"],"web-scrape":["scrape","extract from","crawl"],"code-generate":["write code","generate code","create function"],"code-analyze":["analyze code","review code","explain code"],"blockchain-query":["blockchain","transaction","wallet","balance"],"data-transform":["transform","convert","parse","format"],sentiment:["sentiment","feeling","emotion","tone"],classify:["classify","categorize","label","tag"]};for(let[s,a]of Object.entries(n))a.some(i=>t.includes(i))&&r.push(s);return r.length===0&&r.push("general"),r}d($e,"inferCapabilities");function lt(e){return{summarize:"Condense long text into key points",translate:"Convert text between languages","image-generate":"Create images from text descriptions","image-analyze":"Describe and analyze image contents",search:"Search the web or databases","web-scrape":"Extract data from websites","code-generate":"Write code in various languages","code-analyze":"Review and explain code","blockchain-query":"Query blockchain data","data-transform":"Transform and convert data formats",sentiment:"Analyze emotional tone of text",classify:"Categorize and label content",general:"General-purpose processing"}[e]||"Specialized capability"}d(lt,"getCapabilityDescription");function ut(e,t){if(t.length===0)return{steps:[],totalCost:0,estimatedTime:0};let r=t.slice(0,5).map((n,s)=>({step:s+1,agentId:n.id,agentName:n.name,action:`Execute: ${n.matchedCapabilities.join(", ")}`,estimatedCost:n.pricing.basePrice,estimatedTime:500+s*200}));return{steps:r,totalCost:r.reduce((n,s)=>n+s.estimatedCost,0),estimatedTime:r.reduce((n,s)=>n+s.estimatedTime,0)}}d(ut,"buildExecutionPlan");function dt(e,t,r){let n=[],s=t;if(r)for(let a of r){let i=k.get(a);i&&i.pricing.basePrice<=s&&(n.push(i),s-=i.pricing.basePrice)}for(let a of e){let i=X.get(a);if(i)for(let c of i){if(n.some(o=>o.id===c))continue;let l=k.get(c);l&&l.pricing.basePrice<=s&&(n.push(l),s-=l.pricing.basePrice)}}return n}d(dt,"selectAgentsForTask");function Z(){return`exec_${Date.now()}_${Math.random().toString(36).substring(2,8)}`}d(Z,"generateExecutionId");function pt(){return`agent_${Math.random().toString(36).substring(2,10)}`}d(pt,"generateAgentId");var C=new x,de=new Map,He=new Map,Ne=new Map,Le={sBTC:"SM3VDXK3WZZSA84XXFKAFAF15NNZX32CTSG82JFQ4.sbtc-token",STX:"native",USDh:"SP2VCQJGH7PHP2DJK7Z0V48AGBHQAW3R3ZW1QF4N.usdh"};C.post("/create-invoice",async e=>{let t=await e.req.json(),{amount:r,token:n,recipient:s,memo:a,expiresIn:i}=t;if(!r||!n||!s)return e.json({error:"Required: amount, token, recipient"},400);let c=Be(),l=new Date(Date.now()+(i||300)*1e3).toISOString(),o={id:c,amount:r,token:n,recipient:s,memo:a||`invoice:${c}`,expiresAt:l,status:"pending"};return de.set(c,o),e.json({invoice:{id:o.id,amount:o.amount,token:o.token,recipient:o.recipient,memo:o.memo,expiresAt:o.expiresAt},paymentInstructions:{contract:Le[n],function:n==="STX"?"stx-transfer":"transfer",args:[r,s,o.memo]},qrData:`stacks:${s}?amount=${r}&token=${n}&memo=${o.memo}`})});C.post("/verify",async e=>{let t=await e.req.json(),{txId:r,invoiceId:n}=t;if(!r)return e.json({error:"Transaction ID required"},400);try{let s=await fetch(`https://api.mainnet.hiro.so/extended/v1/tx/${r}`);if(!s.ok)return e.json({error:"Transaction not found"},404);let a=await s.json();if(a.tx_status!=="success")return e.json({verified:!1,status:a.tx_status,error:"Transaction not successful"});let i=ht(a);if(n){let c=de.get(n);if(!c)return e.json({error:"Invoice not found"},404);let l=i.amount>=c.amount&&i.recipient===c.recipient&&i.memo?.includes(c.memo);return l&&(c.status="paid",c.txId=r,de.set(n,c)),e.json({verified:l,invoice:n,transaction:{txId:r,amount:i.amount,token:i.token,sender:i.sender,recipient:i.recipient,memo:i.memo,blockHeight:a.block_height,timestamp:a.burn_block_time_iso}})}return e.json({verified:!0,transaction:{txId:r,status:a.tx_status,type:a.tx_type,sender:a.sender_address,blockHeight:a.block_height,timestamp:a.burn_block_time_iso,...i}})}catch(s){return e.json({error:`Verification failed: ${s.message}`},500)}});C.get("/balance/:address",async e=>{let t=e.req.param("address"),r=He.get(t);return r||(r=await mt(t),He.set(t,r)),e.json({address:t,balances:r,credits:{available:r.sBTC+r.STX*1e-5,locked:0},lastUpdated:new Date().toISOString()})});C.post("/deposit",async e=>{let t=await e.req.json(),{address:r,amount:n,token:s}=t;if(!r||!n||!s)return e.json({error:"Required: address, amount, token"},400);let a={id:Be(),type:"deposit",amount:n,token:s,recipient:"SP2QXPFF4M72QYZWXE7S5321XJDJ2DD32DGEMN5QA",memo:`deposit:${r}`,expiresAt:new Date(Date.now()+3600*1e3).toISOString()};return e.json({depositInstructions:{sendTo:a.recipient,amount:a.amount,token:a.token,memo:a.memo,contract:Le[s]},invoiceId:a.id,expiresAt:a.expiresAt,note:"After sending, call /payments/verify with txId to credit your account"})});C.post("/subscribe",async e=>{let t=await e.req.json(),{subscriber:r,endpointId:n,plan:s,token:a}=t;if(!r||!n||!s)return e.json({error:"Required: subscriber, endpointId, plan"},400);let c={basic:{calls:100,price:1e3,period:"month"},pro:{calls:1e3,price:8e3,period:"month"},unlimited:{calls:-1,price:5e4,period:"month"}}[s];if(!c)return e.json({error:"Invalid plan. Options: basic, pro, unlimited"},400);let l=`sub_${Date.now()}_${Math.random().toString(36).substring(2,8)}`;if(!e.req.header("X-Payment-Proof"))return e.json({error:"Payment Required",payment:{amount:c.price,token:a||"sBTC",recipient:"SP2QXPFF4M72QYZWXE7S5321XJDJ2DD32DGEMN5QA",memo:`subscribe:${l}`},plan:{name:s,...c}},402);let u={id:l,subscriber:r,endpointId:n,plan:s,callsRemaining:c.calls,callsUsed:0,startsAt:new Date().toISOString(),expiresAt:new Date(Date.now()+720*3600*1e3).toISOString(),status:"active"};return Ne.set(l,u),e.json({success:!0,subscription:u})});C.get("/subscription/:id",e=>{let t=e.req.param("id"),r=Ne.get(t);return r?e.json(r):e.json({error:"Subscription not found"},404)});function Be(){return`inv_${Date.now()}_${Math.random().toString(36).substring(2,8)}`}d(Be,"generateInvoiceId");function ht(e){if(e.tx_type==="token_transfer")return{amount:parseInt(e.token_transfer.amount),token:"STX",sender:e.sender_address,recipient:e.token_transfer.recipient_address,memo:e.token_transfer.memo?Buffer.from(e.token_transfer.memo,"hex").toString():void 0};if(e.tx_type==="contract_call"){let t=e.contract_call.function_args||[];return{amount:parseInt(t[0]?.repr?.replace("u","")||"0"),token:e.contract_call.contract_id.includes("sbtc")?"sBTC":"USDh",sender:e.sender_address,recipient:t[2]?.repr?.replace(/'/g,"")||"",memo:t[3]?.repr}}return{amount:0,token:"unknown",sender:e.sender_address,recipient:""}}d(ht,"extractPaymentDetails");async function mt(e){try{let r=await(await fetch(`https://api.mainnet.hiro.so/extended/v1/address/${e}/stx`)).json(),n=parseInt(r.balance||"0"),a=await(await fetch(`https://api.mainnet.hiro.so/extended/v1/address/${e}/balances`)).json(),i=0,c=0,l=a.fungible_tokens||{};for(let[o,u]of Object.entries(l))o.includes("sbtc")&&(i=parseInt(u.balance||"0")),o.includes("usdh")&&(c=parseInt(u.balance||"0"));return{sBTC:i,STX:n,USDh:c}}catch{return{sBTC:0,STX:0,USDh:0}}}d(mt,"fetchOnChainBalances");var _=new x,I=new Map;_.get("/my-endpoints",e=>{let t=e.req.header("X-Owner-Address");if(!t)return e.json({error:"X-Owner-Address header required"},401);let r=[];return I.forEach((n,s)=>{let a=Date.now()-864e5,i=n.calls.filter(l=>l.timestamp>a),c=n.revenue.filter(l=>l.timestamp>a).reduce((l,o)=>l+o.amount,0);r.push({endpointId:s,totalCalls:n.calls.length,calls24h:i.length,totalRevenue:n.revenue.reduce((l,o)=>l+o.amount,0),revenue24h:c,avgResponseTime:n.calls.length>0?n.calls.reduce((l,o)=>l+o.responseTime,0)/n.calls.length:0})}),e.json({owner:t,endpoints:r,summary:{totalEndpoints:r.length,totalCalls:r.reduce((n,s)=>n+s.totalCalls,0),totalRevenue:r.reduce((n,s)=>n+s.totalRevenue,0),calls24h:r.reduce((n,s)=>n+s.calls24h,0),revenue24h:r.reduce((n,s)=>n+s.revenue24h,0)}})});_.get("/revenue",e=>{let t=e.req.header("X-Owner-Address"),r=e.req.query("period")||"7d";if(!t)return e.json({error:"X-Owner-Address header required"},401);let n=ft(r),s=Date.now()-n,a=new Map,i=new Map;I.forEach((o,u)=>{o.revenue.filter(p=>p.timestamp>s).forEach(p=>{let h=new Date(p.timestamp).toISOString().split("T")[0],m=a.get(h)||{sBTC:0,STX:0,USDh:0};m[p.token]+=p.amount,a.set(h,m),i.set(u,(i.get(u)||0)+p.amount)})});let c=Array.from(a.entries()).sort(([o],[u])=>o.localeCompare(u)).map(([o,u])=>({date:o,...u})),l=Array.from(i.entries()).sort(([,o],[,u])=>u-o).slice(0,10).map(([o,u])=>({endpointId:o,revenue:u}));return e.json({period:r,dailyRevenue:c,topEndpoints:l,totals:{sBTC:c.reduce((o,u)=>o+u.sBTC,0),STX:c.reduce((o,u)=>o+u.STX,0),USDh:c.reduce((o,u)=>o+u.USDh,0)}})});_.get("/callers",e=>{let t=e.req.header("X-Owner-Address"),r=e.req.query("endpoint");if(!t)return e.json({error:"X-Owner-Address header required"},401);let n=new Map;(r?[r]:Array.from(I.keys())).forEach(i=>{let c=I.get(i);c&&c.calls.forEach(l=>{let o=n.get(l.caller)||{calls:0,totalPaid:0,avgResponseTime:0,lastSeen:0};o.calls++,o.totalPaid+=l.paid,o.avgResponseTime=(o.avgResponseTime*(o.calls-1)+l.responseTime)/o.calls,o.lastSeen=Math.max(o.lastSeen,l.timestamp),n.set(l.caller,o)})});let a=Array.from(n.entries()).sort(([,i],[,c])=>c.calls-i.calls).slice(0,50).map(([i,c])=>({address:i,...c,lastSeen:new Date(c.lastSeen).toISOString()}));return e.json({endpoint:r||"all",uniqueCallers:n.size,topCallers:a})});_.post("/record-call",async e=>{let t=await e.req.json(),{endpointId:r,caller:n,responseTime:s,paid:a}=t;if(!r||!n)return e.json({error:"Required: endpointId, caller"},400);let i=I.get(r)||{calls:[],revenue:[]};return i.calls.push({timestamp:Date.now(),caller:n,responseTime:s||0,paid:a||0}),a>0&&i.revenue.push({timestamp:Date.now(),amount:a,token:"sBTC",txId:""}),I.set(r,i),e.json({success:!0})});function ft(e){let t=e.match(/^(\d+)([hdwm])$/);if(!t)return 168*3600*1e3;let r=parseInt(t[1]);switch(t[2]){case"h":return r*3600*1e3;case"d":return r*24*3600*1e3;case"w":return r*7*24*3600*1e3;case"m":return r*30*24*3600*1e3;default:return 168*3600*1e3}}d(ft,"parsePeriod");var M=new x;M.post("/generate-middleware",async e=>{let t=await e.req.json(),{language:r,framework:n,price:s,token:a,walletAddress:i}=t;if(!r||!s||!a||!i)return e.json({error:"Required: language, price, token, walletAddress"},400);let c=gt(r,n,s,a,i);return e.json({language:r,framework:n||"none",code:c,usage:yt(r,n)})});M.post("/test-endpoint",async e=>{let t=await e.req.json(),{url:r,method:n="GET"}=t;if(!r)return e.json({error:"URL required"},400);let s=[];try{let a=Date.now(),i=await fetch(r,{method:n}),c=Date.now()-a;s.push({name:"Endpoint reachable",passed:!0,details:`Response time: ${c}ms`});let l=i.status===402;s.push({name:"Returns 402 Payment Required",passed:l,details:l?"Correct status code":`Got ${i.status} instead`});let o=null;if(l)try{o=await i.json()}catch{o=null}let u=!!(o?.maxAmountRequired||o?.amount||o?.payment?.amount);s.push({name:"Contains payment information",passed:u,details:u?`Amount: ${o?.maxAmountRequired||o?.amount||o?.payment?.amount}`:"Missing amount field"});let p=!!(o?.payTo||o?.recipient||o?.payment?.address);s.push({name:"Has recipient address",passed:p,details:p?`Pay to: ${o?.payTo||o?.recipient||o?.payment?.address}`:"Missing recipient field"});let h=!!(o?.tokenType||o?.token||o?.payment?.token);s.push({name:"Token type specified",passed:h,details:h?`Token: ${o?.tokenType||o?.token||o?.payment?.token}`:"Missing token field (defaults to STX)"});let m=!!i.headers.get("Access-Control-Allow-Origin");s.push({name:"CORS enabled",passed:m,details:m?"CORS headers present":"Missing CORS headers (may block browser calls)"});let w=s.every(y=>y.passed),f=s.slice(0,4).every(y=>y.passed);return e.json({url:r,compliant:f,fullyCompliant:w,tests:s,paymentDetails:o,recommendations:bt(s)})}catch(a){return s.push({name:"Endpoint reachable",passed:!1,details:`Error: ${a.message}`}),e.json({url:r,compliant:!1,tests:s,error:a.message})}});M.get("/pricing-calculator",e=>{let t=e.req.query("category")||"utility",r=e.req.query("complexity")||"medium",n=e.req.query("token")||"sBTC",s={sBTC:{usd:1e5},STX:{usd:.5},USDh:{usd:1}},a={utility:1,ai:10,blockchain:5,data:3,media:15},i={simple:.5,medium:1,complex:2,premium:5},c=a[t]||5,l=i[r]||1,o=c*l,u=s[n]||s.sBTC,p=Math.ceil(o/100/u.usd*1e8);return e.json({recommendation:{price:p,token:n,priceUsd:`$${(o/100).toFixed(4)}`},inputs:{category:t,complexity:r},marketData:{token:n,priceUsd:u.usd},comparisons:{sBTC:Math.ceil(o/100/s.sBTC.usd*1e8),STX:Math.ceil(o/100/s.STX.usd*1e6),USDh:Math.ceil(o/100*1e6)},tips:["Start lower to attract users, raise prices as demand grows","AI endpoints can command 5-10x premium over utility endpoints","Consider offering volume discounts via subscriptions","Monitor competitor pricing in the registry"]})});M.get("/sdk/:language",e=>{let t=e.req.param("language"),r={typescript:{package:"@x402/sdk",install:"npm install @x402/sdk",repo:"https://github.com/x402-registry/sdk-typescript",example:`
import { x402 } from '@x402/sdk';

// Create client
const client = x402.createClient({
  wallet: 'SP...',
  privateKey: process.env.STACKS_PRIVATE_KEY,
});

// Call a paid endpoint
const result = await client.call('https://api.example.com/summarize', {
  body: { text: 'Long article...' },
  maxPayment: 1000, // sats
});
`},python:{package:"x402-sdk",install:"pip install x402-sdk",repo:"https://github.com/x402-registry/sdk-python",example:`
from x402 import Client

client = Client(
    wallet="SP...",
    private_key=os.environ["STACKS_PRIVATE_KEY"]
)

result = client.call(
    "https://api.example.com/summarize",
    body={"text": "Long article..."},
    max_payment=1000
)
`},go:{package:"github.com/x402-registry/sdk-go",install:"go get github.com/x402-registry/sdk-go",repo:"https://github.com/x402-registry/sdk-go",example:`
import "github.com/x402-registry/sdk-go"

client := x402.NewClient(x402.Config{
    Wallet:     "SP...",
    PrivateKey: os.Getenv("STACKS_PRIVATE_KEY"),
})

result, err := client.Call("https://api.example.com/summarize", x402.CallOptions{
    Body:       map[string]string{"text": "Long article..."},
    MaxPayment: 1000,
})
`}},n=r[t];return n?e.json({language:t,...n}):e.json({error:"SDK not found",available:Object.keys(r)},404)});function gt(e,t,r,n,s){return e==="typescript"||e==="javascript"?t==="hono"?`
import { MiddlewareHandler } from 'hono';

export const x402Middleware = (): MiddlewareHandler => {
  return async (c, next) => {
    const paymentProof = c.req.header('X-Payment-Proof');

    if (!paymentProof) {
      return c.json({
        error: 'Payment Required',
        payment: {
          amount: ${r},
          token: '${n}',
          address: '${s}',
          memo: 'api-call',
        },
      }, 402);
    }

    // Verify payment on-chain
    const verified = await verifyPayment(paymentProof, ${r});
    if (!verified) {
      return c.json({ error: 'Invalid payment' }, 402);
    }

    await next();
  };
};

async function verifyPayment(txId: string, expectedAmount: number): Promise<boolean> {
  const response = await fetch(\`https://api.mainnet.hiro.so/extended/v1/tx/\${txId}\`);
  const tx = await response.json();
  return tx.tx_status === 'success';
}
`:`
const x402Middleware = (req, res, next) => {
  const paymentProof = req.headers['x-payment-proof'];

  if (!paymentProof) {
    return res.status(402).json({
      error: 'Payment Required',
      payment: {
        amount: ${r},
        token: '${n}',
        address: '${s}',
        memo: 'api-call',
      },
    });
  }

  // Verify payment (implement verification logic)
  next();
};

module.exports = x402Middleware;
`:e==="python"?`
from functools import wraps
from flask import request, jsonify

def x402_required(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        payment_proof = request.headers.get('X-Payment-Proof')

        if not payment_proof:
            return jsonify({
                'error': 'Payment Required',
                'payment': {
                    'amount': ${r},
                    'token': '${n}',
                    'address': '${s}',
                    'memo': 'api-call',
                }
            }), 402

        # Verify payment on-chain
        if not verify_payment(payment_proof, ${r}):
            return jsonify({'error': 'Invalid payment'}), 402

        return f(*args, **kwargs)
    return decorated
`:`// Middleware for ${e} not yet available`}d(gt,"generateMiddlewareCode");function yt(e,t){return e==="typescript"&&t==="hono"?`
// Apply to specific routes:
app.use('/api/paid/*', x402Middleware());

// Or to entire app:
app.use(x402Middleware());
`:e==="python"?`
# Apply to specific routes:
@app.route('/api/paid')
@x402_required
def paid_endpoint():
    return {'data': 'premium content'}
`:"See SDK documentation for usage instructions"}d(yt,"getUsageInstructions");function bt(e){let t=[];return e.forEach(r=>{if(!r.passed)switch(r.name){case"Returns 402 Payment Required":t.push("Return HTTP 402 status code for unpaid requests");break;case"Contains payment information":t.push("Include 'amount' or 'maxAmountRequired' in 402 response body");break;case"Has recipient address":t.push("Include 'payTo' or 'recipient' Stacks address in response");break;case"Token type specified":t.push("Specify 'tokenType' (sBTC, STX, or USDh) in response");break;case"CORS enabled":t.push("Add CORS headers to allow browser-based agent calls");break}}),t.length===0&&(t.push("Your endpoint is fully x402 compliant!"),t.push("Consider registering it at POST /registry/register")),t}d(bt,"generateRecommendations");var T=new x;T.use("*",Me());T.get("/",e=>e.json({name:"x402 Registry",version:"1.0.0",tagline:"The App Store for AI Agents",description:"Discover, register, and orchestrate x402-gated endpoints",endpoints:{"GET /":"API info","GET /stats":"Platform statistics","POST /registry/register":"Register your x402 endpoint","GET /registry/search":"Search endpoints by tag/category","GET /registry/discover":"Trending and featured endpoints","GET /registry/:id":"Get endpoint details","GET /registry/:id/stats":"Endpoint usage statistics","DELETE /registry/:id":"Remove your endpoint","GET /agents/capabilities":"What can agents do?","POST /agents/recommend":"Find agents for a task","GET /agents/:id/openapi":"Machine-readable spec","POST /agents/execute":"Execute a task across agents","POST /agents/chain":"Compose multiple agents","POST /payments/create-invoice":"Create payment request","POST /payments/verify":"Verify a payment","GET /payments/balance/:address":"Check credit balance","POST /payments/deposit":"Add credits","POST /payments/subscribe":"Set up recurring payments","GET /analytics/my-endpoints":"Your endpoint stats","GET /analytics/revenue":"Revenue dashboard","GET /analytics/callers":"Who's calling your APIs","POST /dev/generate-middleware":"Generate x402 middleware code","POST /dev/test-endpoint":"Validate your x402 setup","GET /dev/pricing-calculator":"Optimal pricing suggestions"},tokens:["STX","sBTC","USDh"],network:"stacks-mainnet"}));T.get("/stats",e=>e.json({totalEndpoints:0,totalAgents:0,totalCalls24h:0,totalVolume24h:"0",topCategories:["ai","blockchain","data","utility"],featuredEndpoints:[]}));T.route("/registry",S);T.route("/agents",P);T.route("/payments",C);T.route("/analytics",_);T.route("/dev",M);var kn=T;export{kn as default};
//# sourceMappingURL=index.js.map
